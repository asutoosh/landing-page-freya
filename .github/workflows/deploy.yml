name: Deploy to Hostinger

on:
  push:
    branches:
      - main   # or master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Create package.json and install dependencies
      run: |
        echo '{"dependencies":{"basic-ftp":"^5.0.3"}}' > package.json
        npm install

    - name: Create deploy script
      run: |
        cat > deploy.js << 'DEPLOY_SCRIPT'
        const ftp = require('basic-ftp');
        const fs = require('fs');
        const path = require('path');
        
        async function uploadDirectory(client, localDir, remoteDir) {
          const files = fs.readdirSync(localDir);
          for (const file of files) {
            const localPath = path.join(localDir, file);
            const remotePath = path.join(remoteDir, file).replace(/\\/g, '/');
            const stat = fs.statSync(localPath);
            
            if (stat.isDirectory()) {
              try {
                await client.ensureDir(remotePath);
              } catch (e) {
                // Directory might already exist
              }
              await uploadDirectory(client, localPath, remotePath);
            } else {
              await client.uploadFrom(localPath, remotePath);
              console.log(`✓ Uploaded: ${remotePath}`);
            }
          }
        }
        
        async function deploy() {
          const host = process.env.FTP_HOST;
          const username = process.env.FTP_USERNAME;
          const password = process.env.FTP_PASSWORD;
          
          if (!host || !username || !password) {
            console.error('Missing FTP credentials!');
            console.error('FTP_HOST:', host ? '***' : 'NOT SET');
            console.error('FTP_USERNAME:', username ? '***' : 'NOT SET');
            console.error('FTP_PASSWORD:', password ? '***' : 'NOT SET');
            process.exit(1);
          }
          
          console.log('FTP Host:', host);
          console.log('FTP Username:', username);
          console.log('Connecting to FTP server...');
          
          let client = new ftp.Client();
          client.ftp.verbose = true;
          
          try {
            // Try FTPS first, then fall back to regular FTP
            try {
              console.log('Attempting FTPS connection...');
              await client.access({
                host: host,
                user: username,
                password: password,
                secure: true,
                secureOptions: {
                  rejectUnauthorized: false
                }
              });
              console.log('Connected via FTPS');
            } catch (ftpsError) {
              console.log('FTPS failed, trying regular FTP...');
              console.log('FTPS error:', ftpsError.message);
              client.close();
              client = new ftp.Client();
              client.ftp.verbose = true;
              await client.access({
                host: host,
                user: username,
                password: password,
                secure: false
              });
              console.log('Connected via FTP');
            }
            
            console.log('Connected successfully');
            console.log('Uploading files...');
            
            // Change to public_html directory
            await client.cd('/public_html');
            
            // Upload individual files
            const files = ['index.html', 'pre.html', 'ref.html', 'script.js', 'styles.css'];
            for (const file of files) {
              if (fs.existsSync(file)) {
                await client.uploadFrom(file, file);
                console.log(`✓ Uploaded: ${file}`);
              }
            }
            
            // Upload assets directory
            if (fs.existsSync('assets')) {
              await uploadDirectory(client, 'assets', 'assets');
              console.log('✓ Uploaded: assets/');
            }
            
            client.close();
            console.log('Deployment completed successfully!');
            process.exit(0);
          } catch (err) {
            console.error('Deployment failed:', err.message);
            console.error(err);
            try {
              client.close();
            } catch (e) {
              // Ignore close errors
            }
            process.exit(1);
          }
        }
        
        deploy();
        DEPLOY_SCRIPT

    - name: FTP Deploy
      env:
        FTP_HOST: ${{ vars.FTP_HOST }}
        FTP_USERNAME: ${{ vars.FTP_USERNAME }}
        FTP_PASSWORD: ${{ vars.FTP_PASSWORD }}
      run: node deploy.js

